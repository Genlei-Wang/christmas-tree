# Magical Christmas Tree - 项目方案文档

## 项目概述

"Magical Christmas Tree" 是一个沉浸式Web应用程序，使用Three.js构建3D粒子圣诞树，通过MediaPipe Hands实现手势交互。项目采用单文件HTML结构，包含完整的HTML、CSS和JavaScript代码。

## 视觉风格与界面(UI/UX)

### 背景与色彩
- **背景色**: 黑曜石色 (Obsidian, #050505) 混合深海蓝 (#0B1026)，营造深夜雪原的深邃感
- **雾效**: THREE.Fog(0x0B1026, 50, 200)，增强空间深度感
- **主色调**: 奢华金色 (#D4AF37) 用于UI元素和文字，营造高贵典雅的氛围

### 字体
- **标题字体**: Google Fonts - Italianno (手写体艺术字体)
- **正文字体**: Google Fonts - Outfit (现代无衬线体)

### 布局结构
- **全屏3D画布**: 覆盖整个视口，z-index: 1
- **标题**: "Merry Christmas"，位于页面顶部中央，奢华金色 (#D4AF37)，带有柔和的暖金色光晕
- **左下角摄像头**: 200px宽，150px高，4:3比例，半透明背景和粉色边框，显示用户摄像头画面（镜像）
- **右侧手势侧边栏**: 半透明深色卡片 (rgba(11, 16, 38, 0.7))，列出三种手势说明，当前激活手势高亮显示
- **底部控制栏**: 居中排列两个按钮，高度统一为45px
  - 左侧：圆角长条形"上传回忆"按钮（图标+文字），高度45px，padding: 0 18px，border-radius: 22.5px
  - 右侧：圆形音乐控制按钮（仅图标），45px × 45px，字体大小20px，点击切换播放/暂停
- **加载页**: 带有旋转Spinner和"Loading Magic..."文字的黑色遮罩层，500ms后淡出

## 3D场景与粒子系统

### 主圣诞树
- **粒子数量**: 6000个
- **形状**: 填充整个三角锥形体积
  - 最大高度: 12单位
  - 底部半径: 6单位
  - 顶部半径: 
    - 五角星版本: 0.05单位（形成尖尖）
    - 圆球版本: 0.1单位（确保有足够粒子形成尖尖）
  - Y轴偏移: -5单位（向下移动）
- **粒子分布算法**:
  - 高度分布: `Math.pow(Math.random(), 1.2)` - 底部密度更高，但顶部也有足够粒子形成尖尖
  - 半径分布: `Math.sqrt(Math.random())` - 中心密度更高
  - 添加细微随机偏移，让分布更自然
  - 顶部区域（t > 0.9）减小随机偏移，让粒子更集中在中心形成尖尖
- **颜色渐变**: 五阶段渐变
  1. 底部 (0-15%): 深金色 (#FFB84D) → 暖金色 (#FFD700)
  2. 中下部 (15-40%): 暖金色 → 香槟金 (#F7E7CE)
  3. 中间区 (40-65%): 香槟金 → 玫瑰金 (#E8B4B8)
  4. 中上部 (65-85%): 玫瑰金 → 香槟金
  5. 顶部高光区 (85-100%): 香槟金 → 柠檬绸色 (#FFFACD) → 白色 (#FFFFFF)
- **彩色粒子**: 随机添加10%的彩色粒子
  - 2.5% 绿色 (#00FF88)
  - 2.5% 蓝色 (#00AAFF)
  - 2.5% 紫色 (#AA88FF)
  - 2.5% 红色 (#FF4488)
- **亮度变化**: 0.85-1.15倍随机变化，增强层次感
- **粒子大小**: 
  - 底部 (t < 0.3): 0.03-0.045单位
  - 其他区域: 0.022-0.037单位
  - 所有粒子: ±10%随机变化
- **材质**: PointsMaterial
  - size: 0.03
  - opacity: 0.75
  - sizeAttenuation: true
  - blending: THREE.NormalBlending
  - depthWrite: true
  - depthTest: true
  - renderOrder: 10
- **动画**: 缓慢旋转（rotationAngle += 0.001），聚合/散开平滑过渡

### 顶部装饰

项目提供两个版本：

#### 版本1：五角星 (ChristmasTree.html)
- **类型**: Canvas绘制的五角星Sprite
- **画布**: 512x512像素
- **五角星参数**: 
  - 外圆半径: 180
  - 内圆半径: 70
  - 5个角
- **材质**: SpriteMaterial
  - color: 0xFFFFFF（纯白色）
  - opacity: 1.0
  - blending: THREE.NormalBlending
  - depthWrite: false
  - depthTest: false
- **尺寸**: scale (0.9, 0.9, 1)
- **光晕效果**: 三层金色光晕Sprite（内层1.2，外层2.0，最外层3.0）
  - 使用AdditiveBlending
  - 金色渐变纹理 (512x512)
  - renderOrder: 5（在粒子系统之前）
- **位置**: Y = 7.4（树顶上方0.4单位）
- **renderOrder**: 20（最高，确保在最前面）

#### 版本2：圆球 (ChristmasTree-sphere.html)
- **类型**: 3D球体Mesh
- **几何体**: SphereGeometry(0.2, 32, 32)
- **材质**: MeshBasicMaterial
  - color: 0xFFFFFF（纯白色）
  - opacity: 1.0
  - blending: THREE.NormalBlending
  - depthWrite: false
  - depthTest: false
- **光晕效果**: 单层金色光晕Sprite
  - scale: 1.5
  - opacity: 0.15
  - 使用AdditiveBlending
  - renderOrder: 5
- **位置**: Y = 7.4（树顶上方0.4单位）
- **renderOrder**: 20（最高，确保在最前面）

**注意**: 两个版本的光晕都使用金色渐变纹理，通过renderOrder控制渲染顺序，确保不遮挡树的顶部粒子。

### 装饰小球
- **粒子数量**: 200个
- **颜色**: 金色 (#FFD700) 和宝石红 (#E0115F) 随机分布
  - 70% 金色
  - 30% 宝石红
- **分布**: 集中在树的中部区域（15%-85%高度），分布在树表面附近
- **大小**: 0.02-0.04单位
- **材质**: PointsMaterial
  - size: 0.05
  - opacity: 0.9
  - blending: THREE.AdditiveBlending（增强发光效果）
  - 宝石红粒子亮度: 1.0-1.3倍（更亮，像小灯泡）
- **动画**: 随树旋转，支持聚合/散开

### 雪花系统
- **粒子数量**: 1000个
- **类型**: 六边形雪花（使用Sprite + CanvasTexture）
- **纹理**: 256x256 Canvas绘制
  - 中心六边形
  - 6个主分支
  - 每个主分支上有左右小分支
  - 圆角线条，增强美感
- **材质**: SpriteMaterial
  - opacity: 0.75
  - blending: THREE.AdditiveBlending
- **大小**: 0.12-0.20单位随机变化
- **物理模拟**:
  - 重力下落: -0.02 到 -0.07
  - 风力左右摆动: ±0.02
  - 旋转: ±0.025
- **循环**: 雪花落到Y=-5时重新出现在Y=15

### 彩带系统
- **状态**: 已注释，暂未启用
- **设计**: 800个粒子，4圈螺旋，多色渐变（粉色、深粉、金色、橙色）

## 光照系统

### 环境光
- **类型**: AmbientLight
- **颜色**: 0xffffff
- **强度**: 0.25（降低环境光，增强对比）

### 主光源
- **类型**: DirectionalLight
- **颜色**: 0xFFD700（金色）
- **强度**: 0.8
- **位置**: (0, 15, 5) - 从上方照亮树

### 补光
- **类型**: PointLight
- **颜色**: 0xffdae0（淡粉色）
- **强度**: 0.6
- **位置**: (0, 5, 15) - 从前方照亮

### 背光
- **类型**: PointLight
- **颜色**: 0xE0E0E0（浅灰）
- **强度**: 0.4
- **位置**: (0, 8, -10) - 增强轮廓

## 后处理效果

### UnrealBloomPass
- **强度 (strength)**: 1.3 - 增强辉光，营造电影感
- **半径 (radius)**: 0.55 - 稍微增大辉光半径
- **阈值 (threshold)**: 0.7 - 降低阈值，让更多元素发光

### 材质区分
- **粒子材质**: PointsMaterial，使用NormalBlending，避免过度发光
- **照片材质**: MeshBasicMaterial，color: 0xffffff，确保照片清晰、无辉光

## 交互逻辑 (MediaPipe Hands)

### 手势识别
- **握拳 (Fist) / 无手势**: 
  - 粒子聚合成标准的圆锥形圣诞树
  - 照片缩小为树上的挂饰（scale: 0.3）
  - 当未检测到手时，系统自动回退到此状态
- **张开手掌 (Open Hand)**: 
  - 所有粒子（主树、装饰、星星）散开，随机悬浮在空中
  - 照片散开到随机位置（scale: 0.5）
  - 散开时仍保持旋转动画
- **捏合 (Pinch - 拇指与食指)**: 
  - 触发"聚焦模式"
  - 自动选中离屏幕中心最近的照片

### 捏合聚焦逻辑
- **自动选择**: 计算所有照片到屏幕中心的距离，选择最近的照片
- **磁吸效果**: 选中的照片平滑移动到屏幕正中央
- **绝对居中**: 基于摄像机的目标视线计算位置，确保照片与顶部文字、底部按钮处于同一中轴线
- **正视图锁定**: 照片在聚焦时lookAt摄像机位置，确保照片绝对平行于屏幕，无透视变形
- **尺寸**: 放大后的照片大小约为屏幕高度的70%，保持原始宽高比
- **平滑过渡**: 使用lerp插值，确保动画流畅

### 手势检测算法
- **握拳检测**: 4个手指中至少3个手指弯曲（指尖Y坐标 > 指根Y坐标）
- **张开检测**: 所有4个手指都伸直（指尖Y坐标 < 指根Y坐标）
- **捏合检测**: 拇指与食指距离 < 0.05

## 照片上传系统

### 功能特性
- **多文件上传**: 支持一次选择多张图片
- **格式支持**: 所有图片格式（accept="image/*"）
- **宽高比保持**: 自动读取图片原始宽高比，确保照片不变形
- **初始位置**: 随机分布在3D空间中
- **初始大小**: scale: 0.4（挂饰大小）
- **材质**: MeshBasicMaterial，color: 0xcccccc（降低亮度，避免过亮），toneMapped: true，确保照片清晰

### 照片交互
- **聚合状态**: 围绕树随机分布，scale: 0.4
- **散开状态**: 随机悬浮，scale: 0.5
- **聚焦状态**: 移动到屏幕中心，scale: 屏幕高度的60%，保持原始宽高比，正对摄像机

## 音频系统 (Web Audio API)

### ChristmasSynth类
- **实现方式**: 使用JavaScript的AudioContext，不使用外部MP3文件
- **波形**: 正弦波 (sine)
- **旋律**: 《Snowman》简化版旋律
- **音符序列**: C5-D5-E5-C5-B4-A4-G4-A4-B4-C5

### 自动播放策略
- **页面加载**: 尝试自动播放（非阻塞方式）
- **浏览器拦截处理**: 
  - 如果自动播放失败，监听用户的首次点击/触摸来解锁音频上下文
  - 解锁后自动开始播放
- **音乐按钮**: 实时控制合成器的开启与停止
  - 播放状态: 🎵
  - 暂停状态: 🔇

### 音频参数
- **音量**: 0.1（避免过大）
- **包络**: 线性淡入，指数淡出
- **循环**: 自动循环播放

## 技术栈与库

### 核心技术
- **HTML5**: 语义化结构
- **CSS3**: 现代样式，动画效果
- **ES6 JavaScript (Module)**: 模块化代码组织

### 第三方库
- **Three.js**: v0.160.0
  - CDN: https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js
  - 后处理: EffectComposer, RenderPass, UnrealBloomPass
- **MediaPipe Tasks Vision**: v0.10.3
  - CDN: https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3
  - 动态导入，非阻塞加载
  - GPU加速（delegate: "GPU"）

### 代码结构
- **单文件HTML**: 所有CSS和JS内嵌在HTML文件中
- **模块化组织**: 使用ES6模块导入Three.js
- **异步初始化**: MediaPipe和音频初始化采用非阻塞方式，确保主渲染流程不卡顿

## 性能优化

### 渲染优化
- **粒子系统**: 使用BufferGeometry和BufferAttribute，高效内存使用
- **动画循环**: requestAnimationFrame，60fps流畅动画
- **插值优化**: lerp速度优化（聚合: 0.15，散开: 0.08），确保流畅过渡

### 加载优化
- **MediaPipe**: 动态导入，后台异步加载，不阻塞主流程
- **音频**: 非阻塞初始化，用户交互后解锁
- **加载页**: 500ms固定延迟后隐藏，不等待MediaPipe完成

### 错误处理
- **MediaPipe失败**: 显示友好提示，但不阻止应用运行
- **摄像头失败**: 显示错误提示，应用继续运行
- **音频失败**: 静默处理，用户可通过按钮手动播放

## 浏览器兼容性

### 必需功能
- **WebGL**: 用于Three.js渲染
- **MediaDevices API**: 用于摄像头访问
- **Web Audio API**: 用于音频合成
- **ES6 Modules**: 用于代码组织

### 推荐浏览器
- Chrome/Edge: 90+
- Firefox: 88+
- Safari: 14+

## 项目文件结构

```
Christmas/
├── ChristmasTree.html           # 五角星版本（包含所有HTML、CSS、JS）
├── ChristmasTree-sphere.html    # 圆球版本（包含所有HTML、CSS、JS）
├── 创建圣诞树的详细方案.md        # 本文档
└── 备份.md                       # 备份文档
```

## 使用说明

1. **打开应用**: 
   - 五角星版本：在浏览器中打开 `ChristmasTree.html`
   - 圆球版本：在浏览器中打开 `ChristmasTree-sphere.html`
2. **允许摄像头**: 首次使用时需要允许摄像头权限
3. **手势操作**:
   - 握拳：聚合圣诞树
   - 张开：散开粒子
   - 捏合：聚焦照片
4. **上传照片**: 点击"上传回忆"按钮，选择图片文件
5. **控制音乐**: 点击音乐按钮切换播放/暂停

## 开发历程与优化

### 视觉优化
- 粒子大小多次调整，最终确定为0.03-0.05，避免看出方形
- 颜色渐变优化为四阶段，增强层次感
- 光照系统优化，增加主光源、补光、背光，增强空间感
- 后处理参数精细调整，达到电影级辉光效果

### 交互优化
- 手势识别算法优化，提高识别准确率
- 动画插值速度优化，消除卡顿现象
- 照片聚焦逻辑优化，确保正对摄像机，无透视变形

### 性能优化
- MediaPipe异步加载，不阻塞主渲染
- 音频非阻塞初始化
- 加载页固定延迟，确保用户体验

## 未来扩展方向

1. **更多装饰**: 可启用彩带系统，或添加其他装饰元素
2. **更多手势**: 支持更多手势类型，如挥手、旋转等
3. **照片编辑**: 添加照片滤镜、旋转等功能
4. **音乐选择**: 支持多首圣诞歌曲选择
5. **保存功能**: 支持保存当前场景为图片或视频

---

**项目状态**: ✅ 已完成并优化  
**最后更新**: 2024年12月
